<!DOCTYPE html> 
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人主页 - 基米网</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <script src="./js/main.js"></script>
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5f7fa;
            --success-color: #52c41a;
            --danger-color: #ff4d4f;
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --border-color: #e8ecef;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecef 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: var(--text-primary);
        }

        header {
            background: white;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--text-primary);
            font-size: 1.35rem;
            font-weight: 700;
            transition: transform 0.3s ease;
        }

        .header-brand:hover {
            transform: translateY(-2px);
            color: var(--primary-color);
        }

        .header-brand img {
            width: 45px;
            height: 45px;
            object-fit: contain;
            border-radius: 8px;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, var(--primary-color), #357abd);
            border-radius: 3px;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            background: white;
            overflow: hidden;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .card-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 2px solid var(--border-color);
            padding: 1.25rem 1.5rem;
            font-weight: 600;
        }

        .info-card {
            position: sticky;
            top: 100px;
            align-self: flex-start;
        }

        .info-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info-card .card-header h5 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }

        .info-card .card-header h5::before {
            content: '\f4ff';
            font-family: 'bootstrap-icons';
            color: var(--primary-color);
        }

        .form-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-control {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 0.65rem 1rem;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.15);
        }

        .form-control:disabled,
        .form-control[readonly] {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }

        .btn {
            border-radius: 8px;
            padding: 0.5rem 1.2rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #357abd);
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #357abd, #2868a8);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
            transform: translateY(-2px);
        }

        .btn-outline-secondary {
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
        }

        .btn-outline-secondary:hover {
            background: var(--secondary-color);
            border-color: var(--text-secondary);
            color: var(--text-primary);
        }

        .btn-sm {
            padding: 0.35rem 0.8rem;
            font-size: 0.875rem;
        }

        .module-tabs {
            background: white;
            border-radius: 12px;
            padding: 0.75rem;
            box-shadow: var(--shadow-sm);
            margin-bottom: 1.5rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .module-btn {
            flex: 1;
            min-width: 140px;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            transition: all 0.3s ease;
            position: relative;
            text-decoration: none;
        }

        .module-btn:hover {
            color: var(--primary-color);
            background: rgba(74, 144, 226, 0.08);
        }

        .module-btn.active {
            color: white;
            background: linear-gradient(135deg, var(--primary-color), #357abd);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
        }

        .data-card {
            border: 2px solid var(--border-color);
            margin-bottom: 1.25rem;
            transition: all 0.3s ease;
        }

        .data-card:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-lg);
        }

        .data-card .card-header {
            background: linear-gradient(135deg, #fafbfc 0%, #f0f3f5 100%);
        }

        .data-card .card-header .fw-medium {
            color: var(--primary-color);
            font-size: 1rem;
        }

        .data-card .card-body {
            padding: 1.5rem;
        }

        .data-card .row > div {
            padding: 0.5rem 0;
        }

        .data-card strong {
            color: var(--text-secondary);
            font-size: 0.9rem;
            display: inline-block;
            min-width: 90px;
        }

        .feedback-img {
            max-width: 200px;
            height: auto;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            transition: transform 0.3s ease;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        .feedback-img:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .modal-content {
            border: none;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), #357abd);
            color: white;
            border-radius: 16px 16px 0 0;
            padding: 1.5rem;
        }

        .modal-title {
            font-weight: 700;
            font-size: 1.25rem;
        }

        .btn-close {
            filter: brightness(0) invert(1);
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            padding: 1.5rem;
            background: var(--secondary-color);
            border-top: 2px solid var(--border-color);
        }

        .modal-img-preview {
            max-width: 100%;
            max-height: 250px;
            border-radius: 8px;
            margin-top: 1rem;
            box-shadow: var(--shadow-sm);
        }

        .badge {
            padding: 0.35rem 0.75rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 4rem;
            color: #dfe3e8;
            margin-bottom: 1rem;
        }

        .empty-state p {
            font-size: 1.1rem;
            margin: 0;
        }

        .logout-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff4d4f, #cf1322);
            color: white;
            border: none;
            box-shadow: 0 4px 16px rgba(255, 77, 79, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.3s ease;
            z-index: 999;
        }

        .logout-btn:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 24px rgba(255, 77, 79, 0.5);
            background: linear-gradient(135deg, #cf1322, #a8071a);
        }

        .logout-btn:active {
            transform: translateY(-2px) scale(1.02);
        }

        .logout-btn .tooltip-text {
            position: absolute;
            right: 70px;
            background: #2c3e50;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            white-space: nowrap;
            font-size: 0.9rem;
            font-weight: 600;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .logout-btn .tooltip-text::after {
            content: '';
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            border: 4px solid transparent;
            border-left-color: #2c3e50;
        }

        .logout-btn:hover .tooltip-text {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .page-title {
                font-size: 1.5rem;
            }

            .module-btn {
                min-width: 100%;
            }

            .data-card .card-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start !important;
            }

            .data-card .card-header > div {
                width: 100%;
            }

            .feedback-img {
                max-width: 100%;
            }

            .logout-btn {
                width: 50px;
                height: 50px;
                bottom: 20px;
                right: 20px;
                font-size: 1.2rem;
            }

            .logout-btn .tooltip-text {
                display: none;
            }
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 0.4rem 0.9rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fff7e6;
            color: #fa8c16;
        }

        .status-approved {
            background: #f6ffed;
            color: #52c41a;
        }

        .info-row {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
            line-height: 1.8;
        }

        .info-row strong {
            flex-shrink: 0;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .modal-img-preview {
        max-width: 100%;
        max-height: 200px;
        margin-top: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px;
       }
    </style>
</head>
<body>
    <header class="container-fluid py-3 border-bottom">
        <div class="container d-flex justify-content-between align-items-center">
            <h1 class="page-title mb-0">个人主页</h1>
            <a href="index.html" class="header-brand">
                <img src="./img/logo/logo.png" alt="基米网logo" onerror="this.src='https://via.placeholder.com/45';this.alt='logo加载失败'">
                <span>基米网</span>
            </a>
        </div>
    </header>

    <div class="container mt-4 mb-5">
        
        <div class="row g-4">
            <div class="col-lg-4">
                <div class="card info-card mb-4">
                    <div class="card-header">
                        <h5>公开信息</h5>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline-secondary" id="editPublicInfoBtn" title="修改个人信息">
                                <i class="bi bi-pencil-square"></i> 编辑
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="privacyBtn" title="隐私信息设置">
                                <i class="bi bi-shield-lock"></i> 隐私
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="publicInfoForm">
                            <div class="mb-3">
                                <label for="nickname" class="form-label">
                                    <i class="bi bi-person-circle text-primary"></i> 昵称
                                </label>
                                <input type="text" class="form-control" id="nickname" name="nickname" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="username" class="form-label">
                                    <i class="bi bi-at text-primary"></i> 账户
                                </label>
                                <input type="text" class="form-control" id="username" name="username" disabled>
                            </div>
                            <div class="mb-3">
                                <label for="phone" class="form-label">
                                    <i class="bi bi-telephone text-primary"></i> 联系电话
                                </label>
                                <input type="text" class="form-control" id="phone" name="phone" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="address" class="form-label">
                                    <i class="bi bi-geo-alt text-primary"></i> 居住地址
                                </label>
                                <input type="text" class="form-control" id="address" name="address" readonly>
                            </div>
                            <button type="submit" class="btn btn-primary w-100" id="updatePublicInfoBtn" style="display: none;">
                                <i class="bi bi-check-circle"></i> 保存信息
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="module-tabs">
                    <button class="module-btn active" data-module="adoptFeedback">
                        <i class="bi bi-chat-heart"></i> 收养反馈
                    </button>
                    <button class="module-btn" data-module="adoptApply">
                        <i class="bi bi-file-earmark-text"></i> 收养申请
                    </button>
                    <button class="module-btn" data-module="rescueCase">
                        <i class="bi bi-heart-pulse"></i> 救助信息
                    </button>
                </div>

                <div id="adoptFeedback" class="module-content active">
                    <div id="adoptFeedbackList"></div>
                </div>

                <div id="adoptApply" class="module-content" style="display: none;">
                    <div id="adoptApplyList"></div>
                </div>

                <div id="rescueCase" class="module-content" style="display: none;">
                    <div id="rescueCaseList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 登出按钮 -->
    <button class="logout-btn" onclick="logout()" title="登出">
        <span class="tooltip-text">登出账号</span>
        <i class="bi bi-box-arrow-right"></i>
    </button>

<!-- 收养反馈编辑模态框 -->
<div class="modal fade" id="editFeedbackModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil-square"></i> 编辑收养反馈</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editFeedbackForm">
                    <input type="hidden" id="edit_feedbackId" name="feedbackId">
                    <div class="mb-3">
                        <label for="edit_feedback_content" class="form-label">反馈内容</label>
                        <textarea class="form-control" id="edit_feedback_content" name="content" rows="5"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="edit_feedback_image" class="form-label">反馈图片URL</label>
                        <input type="text" class="form-control" id="edit_feedback_image" name="feedbackImage" 
                               placeholder="请输入图片链接" readonly>
                        <img id="feedback_img_preview" class="modal-img-preview" style="display:none;">
                    </div>
                    <!-- 新增图片上传组件 -->
                    <div class="mb-3">
                        <label class="form-label">或上传图片</label>
                        <div class="input-group">
                            <input type="file" class="form-control" id="imageUpload" accept="image/*">
                            <button class="btn btn-outline-secondary" type="button" id="clearImage">
                                <i class="bi bi-trash"></i> 清除
                            </button>
                        </div>
                        <div class="form-text">支持 JPG、PNG、GIF 格式，最大 5MB</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> 取消
                </button>
                <button type="button" class="btn btn-primary" onclick="saveFeedback()">
                    <i class="bi bi-check-circle"></i> 保存修改
                </button>
            </div>
        </div>
    </div>
</div>

    <!-- 收养申请编辑模态框 -->
    <div class="modal fade" id="editApplyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil-square"></i> 编辑收养申请</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editApplyForm">
                        <input type="hidden" id="edit_applyId" name="applyId">
                        <div class="mb-3">
                            <label for="edit_apply_petId" class="form-label">宠物ID</label>
                            <input type="text" class="form-control" id="edit_apply_petId" name="petId" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="edit_apply_reason" class="form-label">申请理由</label>
                            <textarea class="form-control" id="edit_apply_reason" name="applyReason" rows="5"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> 取消
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveApply()">
                        <i class="bi bi-check-circle"></i> 保存修改
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- 救助信息编辑模态框 --> 
    <div class="modal fade" id="editRescueModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil-square"></i> 编辑救助信息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editRescueForm">
                        <input type="hidden" id="edit_rescue_caseId" name="caseId">
                        <div class="mb-3">
                            <label for="edit_rescue_title" class="form-label">救助标题</label>
                            <input type="text" class="form-control" id="edit_rescue_title" name="title">
                        </div>
                        <div class="mb-3">
                            <label for="edit_rescue_place" class="form-label">救助地点</label>
                            <input type="text" class="form-control" id="edit_rescue_place" name="rescuePlace">
                        </div>
                        <!-- 修改救助关联理由为 content -->
                        <div class="mb-3">
                            <label for="edit_rescue_content" class="form-label">救助内容</label>
                            <textarea class="form-control" id="edit_rescue_content" name="content" rows="5"></textarea>
                        </div>
                        <!-- 将宠物ID字段改为宠物昵称 -->
                        <div class="mb-3">
                            <label for="edit_rescue_petName" class="form-label">宠物昵称</label>
                            <input type="text" class="form-control" id="edit_rescue_petName" name="petName" readonly>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> 取消
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveRescue()">
                        <i class="bi bi-check-circle"></i> 保存修改
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const userId = localStorage.getItem('userId');
        const editPublicInfoBtn = document.getElementById('editPublicInfoBtn');
        const privacyBtn = document.getElementById('privacyBtn');
        const updatePublicInfoBtn = document.getElementById('updatePublicInfoBtn');
        const publicInfoInputs = document.querySelectorAll('#publicInfoForm input:not(#username)');
        const publicInfoForm = document.getElementById('publicInfoForm');

        let feedbackModal, applyModal, rescueModal;
        document.addEventListener('DOMContentLoaded', function() {
            feedbackModal = new bootstrap.Modal(document.getElementById('editFeedbackModal'));
            applyModal = new bootstrap.Modal(document.getElementById('editApplyModal'));
            rescueModal = new bootstrap.Modal(document.getElementById('editRescueModal'));
        });

        editPublicInfoBtn.addEventListener('click', () => {
            publicInfoInputs.forEach(input => input.removeAttribute('readonly'));
            updatePublicInfoBtn.style.display = 'inline-block';
            alert('已进入个人信息编辑模式，修改后点击"保存信息"保存');
        });

        privacyBtn.addEventListener('click', () => {
            window.location.href = 'edit.html';
        });

        publicInfoForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(publicInfoForm);
            const infoData = Object.fromEntries(formData.entries());

            fetch(`http://localhost:8080/personal/updatePublicInfo`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(infoData)
            })
            .then(response => response.json())
            .then(data => {
                if (data === 1) {
                    alert('个人信息更新成功！');
                    publicInfoInputs.forEach(input => input.setAttribute('readonly', true));
                    updatePublicInfoBtn.style.display = 'none';
                } else {
                    alert('更新失败：' + (data.msg || '未知错误'));
                }
            })
            .catch(error => console.error('Error updating public info:', error));
        });

        fetch(`http://localhost:8080/personal/getPublicInfo`, {
            method: 'GET'
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('nickname').value = data.nickname || '';
            document.getElementById('username').value = data.username || '';
            document.getElementById('phone').value = data.phone || '';
            document.getElementById('address').value = data.address || '';
        })
        .catch(error => console.error('Error fetching public info:', error));

        function getAdoptFeedback() {
            fetch(`http://localhost:8080/personal/getAdoptFeedback`, {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                const adoptFeedbackList = document.getElementById('adoptFeedbackList');
                if (data.length === 0) {
                    adoptFeedbackList.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-inbox"></i>
                            <p>暂无收养反馈记录</p>
                        </div>
                    `;
                    return;
                }
                adoptFeedbackList.innerHTML = data.map(feedback => `
                    <div class="card data-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span class="fw-medium"><i class="bi bi-hash"></i> 反馈ID：${feedback.feedbackId}</span>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary" onclick='editAdoptFeedback(${JSON.stringify(feedback)})'>
                                    <i class="bi bi-pencil"></i> 修改
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteAdoptFeedback(${feedback.feedbackId})">
                                    <i class="bi bi-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="info-row">
                                        <strong><i class="bi bi-chat-left-text"></i> 反馈内容：</strong>
                                        <span>${feedback.content || '无反馈内容'}</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-row">
                                        <strong><i class="bi bi-link-45deg"></i> 关联申请ID：</strong>
                                        <span>${feedback.applyId || '未关联'}</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-row">
                                        <strong><i class="bi bi-calendar-event"></i> 反馈时间：</strong>
                                        <span>${feedback.feedbackTime || '未记录'}</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-row">
                                        <strong><i class="bi bi-heart-fill text-danger"></i> 点赞数：</strong>
                                        <span class="badge bg-danger">${feedback.likeCount || 0}</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-row">
                                        <strong><i class="bi bi-clock"></i> 创建时间：</strong>
                                        <span>${formatTime(feedback.createTime) || '未记录'}</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-row">
                                        <strong><i class="bi bi-clock-history"></i> 更新时间：</strong>
                                        <span>${formatTime(feedback.updateTime) || '未更新'}</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <strong><i class="bi bi-image"></i> 反馈图片：</strong><br>
                                    <img src="${feedback.feedbackImage}" class="feedback-img mt-2" 
                                         alt="反馈图片" onerror="this.src='https://via.placeholder.com/200x150?text=无图片';this.alt='图片加载失败'">
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            })
            .catch(error => console.error('Error fetching adopt feedback:', error));
        }

        function editAdoptFeedback(feedback) {
            document.getElementById('edit_feedbackId').value = feedback.feedbackId;
            document.getElementById('edit_feedback_content').value = feedback.content || '';
            document.getElementById('edit_feedback_image').value = feedback.feedbackImage || '';
            
            const imgPreview = document.getElementById('feedback_img_preview');
            if (feedback.feedbackImage) {
                imgPreview.src = feedback.feedbackImage;
                imgPreview.style.display = 'block';
            } else {
                imgPreview.style.display = 'none';
            }
            
            feedbackModal.show();
        }

        function saveFeedback() {
            const formData = new FormData(document.getElementById('editFeedbackForm'));
            const feedbackData = Object.fromEntries(formData.entries());

            fetch(`http://localhost:8080/personal/updateAdoptFeedback`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(feedbackData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success || data === 1) {
                    alert('收养反馈更新成功！');
                    feedbackModal.hide();
                    getAdoptFeedback();
                } else {
                    alert('更新失败：' + (data.msg || '未知错误'));
                }
            })
            .catch(error => {
                console.error('Error updating feedback:', error);
                alert('更新失败，请检查网络连接');
            });
        }

        function deleteAdoptFeedback(feedbackId) {
            if (confirm(`确定删除ID为 ${feedbackId} 的收养反馈吗？删除后不可恢复！`)) {
                fetch(`http://localhost:8080/personal/deleteAdoptFeedback?feedbackId=${feedbackId}`, {
                    method: 'PUT'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success || data === 1) {
                        alert('删除成功！');
                        getAdoptFeedback();
                    } else {
                        alert('删除失败：' + (data.msg || '未知错误'));
                    }
                })
                .catch(error => console.error('Error deleting adopt feedback:', error));
            }
        }

        function getAdoptApply() {
            fetch(`http://localhost:8080/personal/getAdoptionApply`, {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                const adoptApplyList = document.getElementById('adoptApplyList');
                if (data.length === 0) {
                    adoptApplyList.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-inbox"></i>
                            <p>暂无收养申请记录</p>
                        </div>
                    `;
                    return;
                }
                adoptApplyList.innerHTML = data.map(application => `
                    <div class="card data-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span class="fw-medium"><i class="bi bi-hash"></i> 申请ID：${application.applyId}</span>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary" onclick='editAdoptApply(${JSON.stringify(application)})'>
                                    <i class="bi bi-pencil"></i> 修改
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteAdoptApply(${application.applyId})">
                                    <i class="bi bi-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="info-row">
                                        <strong><i class="bi bi-person"></i> 用户ID：</strong>
                                        <span>${application.userId || '未知'}</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-row">
                                        <strong><i class="bi bi-piggy-bank"></i> 宠物ID：</strong>
                                        <span>${application.petId || '未知'}</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="info-row">
                                        <strong><i class="bi bi-chat-left-text"></i> 申请理由：</strong>
                                        <span>${application.applyReason || '无申请理由'}</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-row">
                                        <strong><i class="bi bi-calendar-event"></i> 申请时间：</strong>
                                        <span>${application.applyTime || '未记录'}</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-row">
                                        <strong><i class="bi bi-check-circle"></i> 审核状态：</strong>
                                        <span>${formatAuditStatus(application.auditStatus)}</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-row">
                                        <strong><i class="bi bi-clipboard-check"></i> 审核备注：</strong>
                                        <span>${application.auditRemark || '无备注'}</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-row">
                                        <strong><i class="bi bi-calendar-check"></i> 审核时间：</strong>
                                        <span>${application.auditTime || '未审核'}</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-row">
                                        <strong><i class="bi bi-heart"></i> 领养时间：</strong>
                                        <span>${formatTime(application.adoptTime) || '未领养'}</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-row">
                                        <strong><i class="bi bi-clock"></i> 创建时间：</strong>
                                        <span>${formatTime(application.createTime) || '未记录'}</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-row">
                                        <strong><i class="bi bi-clock-history"></i> 更新时间：</strong>
                                        <span>${formatTime(application.updateTime) || '未更新'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            })
            .catch(error => console.error('Error fetching adoption apply:', error));
        }

        function editAdoptApply(application) {
            document.getElementById('edit_applyId').value = application.applyId;
            document.getElementById('edit_apply_petId').value = application.petId || '';
            document.getElementById('edit_apply_reason').value = application.applyReason || '';
            
            applyModal.show();
        }

        function saveApply() {
            const formData = new FormData(document.getElementById('editApplyForm'));
            const applyData = Object.fromEntries(formData.entries());

            fetch(`http://localhost:8080/personal/updateAdoptionApply`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(applyData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success || data === 1) {
                    alert('收养申请更新成功！');
                    applyModal.hide();
                    getAdoptApply();
                } else {
                    alert('更新失败：' + (data.msg || '未知错误'));
                }
            })
            .catch(error => {
                console.error('Error updating apply:', error);
                alert('更新失败，请检查网络连接');
            });
        }

        function deleteAdoptApply(applyId) {
            if (confirm(`确定删除ID为 ${applyId} 的收养申请吗？删除后不可恢复！`)) {
                fetch(`http://localhost:8080/personal/deleteAdoptionApply?applyId=${applyId}`, {
                    method: 'PUT'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success || data === 1) {
                        alert('删除成功！');
                        getAdoptApply();
                    } else {
                        alert('删除失败：' + (data.msg || '未知错误'));
                    }
                })
                .catch(error => console.error('Error deleting adoption apply:', error));
            }
        }

        function getRescueCase() {
            fetch(`http://localhost:8080/personal/getRescueCase`, {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                const rescueCaseList = document.getElementById('rescueCaseList');
                if (data.length === 0) {
                    rescueCaseList.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-inbox"></i>
                            <p>暂无救助信息记录</p>
                        </div>
                    `;
                    return;
                }
            rescueCaseList.innerHTML = data.map(caseItem => `
                <div class="card data-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="fw-medium"><i class="bi bi-hash"></i> 救助编号：${caseItem.caseId || '无编号'}</span>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary" onclick='editRescueCase(${JSON.stringify(caseItem)})'>
                                <i class="bi bi-pencil"></i> 修改
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRescueCase(${caseItem.caseId})">
                                <i class="bi bi-trash"></i> 删除
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="info-row">
                                    <strong><i class="bi bi-card-heading"></i> 救助标题：</strong>
                                    <span class="fs-5 fw-semibold text-primary">${caseItem.title || '无标题'}</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-row">
                                    <strong><i class="bi bi-person"></i> 救助人昵称：</strong>
                                    <span>${caseItem.nickName || '未知'}</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-row">
                                    <strong><i class="bi bi-piggy-bank"></i> 救助花费：</strong>
                                    <span>${caseItem.rescueCost || 0} 元</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-row">
                                    <strong><i class="bi bi-geo-alt"></i> 救助地点：</strong>
                                    <span>${caseItem.rescuePlace || '未记录'}</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-row">
                                    <strong><i class="bi bi-eye"></i> 浏览量：</strong>
                                    <span class="badge bg-info">${caseItem.viewCount || 0}</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-row">
                                    <strong><i class="bi bi-calendar-check"></i> 发布时间：</strong>
                                    <span>${formatTime(caseItem.publishTime) || '未记录'}</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-row">
                                    <strong><i class="bi bi-check-circle"></i> 案例状态：</strong>
                                    <span>${caseItem.status === 1 ? '已完成' : '救助中'}</span>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="info-row">
                                    <strong><i class="bi bi-chat-left-text"></i> 救助内容：</strong>
                                    <p>${caseItem.content || '无内容'}</p>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="info-row">
                                    <strong><i class="bi bi-image"></i> 救助图片：</strong>
                                    <img src="${caseItem.imageUrl}" alt="救助图片" class="img-fluid" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            })
            .catch(error => console.error('Error fetching rescue case:', error));
        }

        function editRescueCase(caseItem) {
        document.getElementById('edit_rescue_caseId').value = caseItem.caseId; 
        document.getElementById('edit_rescue_title').value = caseItem.title || '';
        document.getElementById('edit_rescue_place').value = caseItem.rescuePlace || '';
        document.getElementById('edit_rescue_content').value = caseItem.content || '';
        document.getElementById('edit_rescue_petName').value = caseItem.petName || '';

                
            rescueModal.show();
        }

        function saveRescue() {
            const formData = new FormData(document.getElementById('editRescueForm'));
            const rescueData = Object.fromEntries(formData.entries());

            fetch(`http://localhost:8080/personal/updateRescueCase`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(rescueData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success || data === 1) {
                    alert('救助信息更新成功！');
                    rescueModal.hide();
                    getRescueCase();
                } else {
                    alert('更新失败：' + (data.msg || '未知错误'));
                }
            })
            .catch(error => {
                console.error('Error updating rescue:', error);
                alert('更新失败，请检查网络连接');
            });
        }

        function deleteRescueCase(caseId) {
            if (confirm(`确定删除关联ID为 ${caseId} 的救助信息吗？删除后不可恢复！`)) {
                fetch(`http://localhost:8080/personal/deleteRescueCase?caseId=${caseId}`, {
                    method: 'PUT'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success || data === 1) {
                        alert('删除成功！');
                        getRescueCase();
                    } else {
                        alert('删除失败：' + (data.msg || '未知错误'));
                    }
                })
                .catch(error => console.error('Error deleting rescue case:', error));
            }
        }

        function switchModule(module) {
            // 隐藏所有模块内容
            document.querySelectorAll('.module-content').forEach(el => {
                el.classList.remove('active');
                el.style.display = 'none';
            });
            
            // 移除所有按钮的active类
            document.querySelectorAll('.module-btn').forEach(btn => btn.classList.remove('active'));
            
            // 显示当前模块
            const currentModule = document.getElementById(module);
            currentModule.classList.add('active');
            currentModule.style.display = 'block';
            
            // 激活当前按钮
            document.querySelector(`[data-module="${module}"]`).classList.add('active');
            
            // 加载数据
            if (module === 'adoptFeedback') getAdoptFeedback();
            if (module === 'adoptApply') getAdoptApply();
            if (module === 'rescueCase') getRescueCase();
        }

        document.querySelectorAll('.module-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const module = this.getAttribute('data-module');
                switchModule(module);
            });
        });

        function formatTime(time) {
            if (!time) return null;
            const date = new Date(time);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function formatAuditStatus(status) {
            if (status === 0) {
                return '<span class="status-badge status-pending"><i class="bi bi-clock"></i> 待审核</span>';
            } else if (status === 1) {
                return '<span class="status-badge status-approved"><i class="bi bi-check-circle"></i> 已通过</span>';
            }
            return '<span class="status-badge status-pending">未审核</span>';
        }

        document.getElementById('edit_feedback_image').addEventListener('input', function(e) {
            const imgPreview = document.getElementById('feedback_img_preview');
            if (e.target.value) {
                imgPreview.src = e.target.value;
                imgPreview.style.display = 'block';
            } else {
                imgPreview.style.display = 'none';
            }
        });

// 图片上传处理
document.getElementById('imageUpload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    // 验证文件类型
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
    if (!validTypes.includes(file.type)) {
        alert('请上传有效的图片文件（JPG、PNG、GIF）');
        this.value = '';
        return;
    }

    // 验证文件大小（5MB）
    const maxSize = 5 * 1024 * 1024;
    if (file.size > maxSize) {
        alert('图片大小不能超过 5MB');
        this.value = '';
        return;
    }

    // 转换为base64
    const reader = new FileReader();
    reader.onload = function(e) {
        const base64String = e.target.result;
        
        // 填充到输入框
        document.getElementById('edit_feedback_image').value = base64String;
        
        // 显示预览
        const preview = document.getElementById('feedback_img_preview');
        preview.src = base64String;
        preview.style.display = 'block';
    };
    reader.readAsDataURL(file);
});


        function logout() {
        // 1. 清 token（localStorage）
        localStorage.removeItem('hachimitoken');
        // 2. 跳转
        location.href = './index.html';
        }

        switchModule('adoptFeedback');
    </script>
</body>
</html>