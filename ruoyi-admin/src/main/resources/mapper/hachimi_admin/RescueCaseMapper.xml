<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.hachimi_admin.mapper.RescueCaseMapper">

    <resultMap type="RescueCase" id="RescueCaseResult">
        <result property="caseId"    column="case_id"    />
        <result property="title"    column="title"    />
        <result property="petId"    column="pet_id"    />
        <result property="petName"    column="pet_name"    />
        <result property="content"    column="content"    />
        <result property="rescueCost"    column="rescue_cost"    />
        <result property="status"    column="status"    />
        <result property="publishTime"    column="publish_time"    />
        <result property="createUserId"    column="create_user_id"    />
        <result property="createUserName"    column="create_user_name"    />
        <result property="viewCount"    column="view_count"    />
        <result property="hidden"    column="hidden"    />
    </resultMap>

    <resultMap id="RescueCaseCaseImageResult" type="RescueCase" extends="RescueCaseResult">
        <collection property="caseImageList" ofType="CaseImage" column="case_id" select="selectCaseImageList" />
    </resultMap>

    <resultMap type="CaseImage" id="CaseImageResult">
        <result property="caseImageId"    column="case_image_id"    />
        <result property="caseId"    column="case_id"    />
        <result property="imageUrl"    column="image_url"    />
        <result property="sort"    column="sort"    />
        <result property="hidden"    column="hidden"    />
        <result property="uploadTime"    column="upload_time"    />
    </resultMap>

    <sql id="selectRescueCaseVo">
        select
            rc.case_id,
            rc.title,
            rc.pet_id,
            p.pet_name,
            rc.content,
            rc.rescue_cost,
            rc.status,
            rc.publish_time,
            rc.create_user_id,
            u.nickname as create_user_name,
            rc.view_count,
            rc.hidden
        from rescue_case rc
                 left join pet p on rc.pet_id = p.pet_id
                 left join user u on rc.create_user_id = u.user_id
    </sql>

    <select id="selectRescueCaseList" parameterType="RescueCase" resultMap="RescueCaseResult">
        <include refid="selectRescueCaseVo"/>
        <where>
            <if test="title != null  and title != ''"> and rc.title like concat('%', #{title}, '%')</if>
        </where>
    </select>

    <select id="selectRescueCaseByCaseId" parameterType="Long" resultMap="RescueCaseCaseImageResult">
        select
            rc.case_id,
            rc.title,
            rc.pet_id,
            p.pet_name,
            rc.content,
            rc.rescue_cost,
            rc.status,
            rc.publish_time,
            rc.create_user_id,
            u.nickname as create_user_name,
            rc.view_count,
            rc.hidden
        from rescue_case rc
                 left join pet p on rc.pet_id = p.pet_id
                 left join user u on rc.create_user_id = u.user_id
        where rc.case_id = #{caseId}
    </select>

    <select id="selectCaseImageList" resultMap="CaseImageResult">
        select case_image_id, case_id, image_url, sort, hidden, upload_time
        from case_image
        where case_id = #{case_id}
    </select>

    <insert id="insertRescueCase" parameterType="RescueCase" useGeneratedKeys="true" keyProperty="caseId">
        insert into rescue_case
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="title != null">title,</if>
            <if test="petId != null">pet_id,</if>
            <if test="content != null">content,</if>
            <if test="rescueCost != null">rescue_cost,</if>
            <if test="status != null">status,</if>
            <if test="publishTime != null">publish_time,</if>
            <if test="createUserId != null">create_user_id,</if>
            <if test="viewCount != null">view_count,</if>
            <if test="hidden != null">hidden,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="title != null">#{title},</if>
            <if test="petId != null">#{petId},</if>
            <if test="content != null">#{content},</if>
            <if test="rescueCost != null">#{rescueCost},</if>
            <if test="status != null">#{status},</if>
            <if test="publishTime != null">#{publishTime},</if>
            <if test="createUserId != null">#{createUserId},</if>
            <if test="viewCount != null">#{viewCount},</if>
            <if test="hidden != null">#{hidden},</if>
        </trim>
    </insert>

    <update id="updateRescueCase" parameterType="RescueCase">
        update rescue_case
        <trim prefix="SET" suffixOverrides=",">
            <if test="title != null">title = #{title},</if>
            <if test="petId != null">pet_id = #{petId},</if>
            <if test="content != null">content = #{content},</if>
            <if test="rescueCost != null">rescue_cost = #{rescueCost},</if>
            <if test="status != null">status = #{status},</if>
            <if test="publishTime != null">publish_time = #{publishTime},</if>
            <if test="createUserId != null">create_user_id = #{createUserId},</if>
            <if test="viewCount != null">view_count = #{viewCount},</if>
            <if test="hidden != null">hidden = #{hidden},</if>
        </trim>
        where case_id = #{caseId}
    </update>

    <delete id="deleteRescueCaseByCaseId" parameterType="Long">
        delete from rescue_case where case_id = #{caseId}
    </delete>

    <delete id="deleteRescueCaseByCaseIds" parameterType="String">
        delete from rescue_case where case_id in
        <foreach item="caseId" collection="array" open="(" separator="," close=")">
            #{caseId}
        </foreach>
    </delete>

    <delete id="deleteCaseImageByCaseIds" parameterType="String">
        delete from case_image where case_id in
        <foreach item="caseId" collection="array" open="(" separator="," close=")">
            #{caseId}
        </foreach>
    </delete>

    <delete id="deleteCaseImageByCaseId" parameterType="Long">
        delete from case_image where case_id = #{caseId}
    </delete>

    <insert id="batchCaseImage">
        insert into case_image( case_image_id, case_id, image_url, sort, hidden, upload_time) values
        <foreach item="item" index="index" collection="list" separator=",">
            ( #{item.caseImageId}, #{item.caseId}, #{item.imageUrl}, #{item.sort}, #{item.hidden}, #{item.uploadTime})
        </foreach>
    </insert>
</mapper>